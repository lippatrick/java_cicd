/*
  CI pipeline for the java_cicd project.

  Flow:
  1) Checks out the source from GitHub (main branch)
  2) Compiles the project using Maven (JDK 11 + Maven 3)
  3) Runs static code analysis with SonarQube via SonarScanner
  4) Runs OWASP Dependency-Check to scan for vulnerable dependencies and publishes the report
  5) Packages the application jar (tests skipped for pipeline continuity)
  6) Builds a Docker image from docker/Dockerfile and pushes it to Docker Hub (lipatrick/java_cicd:latest)
  7) Triggers the separate CD job (java_CD) to deploy the pushed image
*/

pipeline {
    agent any
    tools{
        jdk 'jdk11'
        maven 'maven3'
    }
    
    environment{
        SCANNER_HOME=tool 'sonar-scanner'
    } 
    stages {
        stage('Git Checkout') {
            steps {
                git branch: 'main', changelog: false, poll: false, url: 'https://github.com/lippatrick/java_cicd.git'
            }
        }
        stage('Compile') {
            steps {
                sh "mvn clean compile"
            }
        }
        stage('SonarQube Analysis') {
            steps {
                sh ''' $SCANNER_HOME/bin/sonar-scanner -Dsonar.host.url=http://13.61.105.152:9000/ -Dsonar.login=<put your_token generated> -Dsonar.projectName=java_cicd -Dsonar.projectKey=java_cicd \
                -Dsonar.java.binaries=. '''
            }
        }
        stage('OWASP SCAN') {
          steps {
            dependencyCheck additionalArguments: '--scan ./', odcInstallation: 'DP'
            dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
          }
        }
        
        stage('Build Application') {
            steps {
                sh "mvn -B clean package -DskipTests"
            }
        }
        stage('Build & Push Docker Image') {
          steps {
            script {
              withDockerRegistry(credentialsId: 'mydocker') {
                sh '''
                  set -e
                  docker build -t java_cicd:latest -f docker/Dockerfile .
                  docker tag java_cicd:latest lipatrick/java_cicd:latest
                  docker push lipatrick/java_cicd:latest
                '''
              }
            }
          }
        }
        stage('Trigger CD Pipeline') {
            steps {
                build job: "java_CD"
            }
        }
    }
}
